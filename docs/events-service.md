# Events-Service

Spring Boot сервис для управления событиями, направлениями (компетенциями), платформами и регистрацией
участников для системы управления чемионатом Искатели профессий.

## Оглавление

- [Обзор](#обзор)
- [Технологический стек](#технологический-стек)
- [Структура проекта](#структура-проекта)
- [Эндпоинты API](#эндпоинты-api)
    - [Контроллер событий](#контроллер-событий)
    - [Контроллер направлений](#контроллер-направлений)
    - [Контроллер платформ](#контроллер-платформ)
    - [Контроллер Child to Direction](#контроллер-child-to-direction-ребёнок-к-направлению)
    - [Контроллер документов направлений](#контроллер-документов-направлений)
    - [Контроллер возрастных категорий](#контроллер-возрастных-категорий)
    - [Контроллер отчётов](#контроллер-отчётов)
    - [Контроллер статистики](#контроллер-статистики-устарело)
- [Типы документов](#типы-документов)
- [Функции](#функции)
    - [Ограниченный по времени доступ](#ограниченный-по-времени-доступ)
    - [Проверка событий](#проверка-событий)
    - [Управление очередью участников](#управление-очередью-участников)
    - [Интеграция с Kafka](#интеграция-с-kafka)
    - [gRPC-коммуникация](#grpc-коммуникация)
    - [Кэширование](#кэширование)
    - [Генерация отчётов](#генерация-отчётов)
    - [Поддержка WebSocket](#поддержка-websocket)

## Обзор

**Events-Service** — это микросервис на Kotlin, который предоставляет комплексное управление образовательными
событиями, направлениями компетенций, возрастными категориями и отслеживанием участников. Он служит основным бэкендом
для организации соревнований, мастер-классов и квалификационных мероприятий для детей разных возрастных групп.

## Технологический стек

- **Основа**: Kotlin + Spring Boot 3.5.0
- **База данных**: PostgreSQL
- **Кэширование**: Redis
- **Обмен сообщениями**: Apache Kafka, gRPC, GraphQL
- **API**: REST, WebSocket

## Структура проекта

```
src/main/kotlin/org/careerseekers/cseventsservice/
├── annotations/          # Custom annotations (@AccessUntil, @EventVerification, etc.)
├── aspects/              # AOP aspects for cross-cutting concerns
├── cache/                # Redis cache configuration and clients
├── clients/              # External service clients (GraphQL)
├── config/               # Application configuration classes
├── controllers/          # REST API controllers
│   └── interfaces/       # Controller interfaces for CRUD operations
├── dto/                  # Data Transfer Objects
│   ├── directions/       # Direction-related DTOs
│   ├── docs/             # Document DTOs
│   ├── events/           # Event DTOs
│   ├── files/            # File structure DTOs
│   ├── graphql/          # GraphQL response DTOs
│   ├── platforms/        # Platform DTOs
│   └── rapports/         # Report DTOs
├── entities/             # JPA entities
├── enums/                # Enumeration types
├── exceptions/           # Custom exception classes
├── io/                   # I/O utilities and converters
│   ├── converters/       # Type converters and extensions
│   ├── filters/          # Request filters (JWT)
│   └── handlers/         # Exception handlers
├── mappers/              # MapStruct mappers
├── repositories/         # Spring Data JPA repositories
│   └── spec/             # JPA Specifications
├── security/             # Security configuration
├── serializers/          # Custom serializers
└── services/             # Business logic services
    └── interfaces/       # Service interfaces
```

## Эндпоинты API

### Контроллер событий

Базовый путь: `/events-service/v1/events`

| Метод  | Эндпоинт                   | Описание                                        |
|--------|----------------------------|-------------------------------------------------|
| GET    | `/`                        | Получить все события (с пагинацией и фильтрами) |
| GET    | `/{id}`                    | Получить событие по ID                          | 
| GET    | `/getByDirectionId/{id}`   | Получить события по ID направления              | 
| GET    | `/getByAgeCategoryId/{id}` | Получить события по ID возрастной категории     | 
| POST   | `/`                        | Создать новое событие                           | 
| POST   | `/createAll`               | Пакетное создание событий                       | 
| PATCH  | `/`                        | Обновить событие                                | 
| PATCH  | `/verify`                  | Проверить событие                               | 
| DELETE | `/{id}`                    | Удалить событие по ID                           | 
| DELETE | `/`                        | Удалить все события                             | 

### Контроллер направлений

Базовый путь: `/events-service/v1/directions`

| Метод  | Эндпоинт                          | Описание                                     |
|--------|-----------------------------------|----------------------------------------------|
| GET    | `/`                               | Получить все направления                     |
| GET    | `/{id}`                           | Получить направление по ID                   |
| GET    | `/getByUserId/{userId}`           | Получить направления по ID тьютора           |
| GET    | `/getByExpertId/{id}`             | Получить направления по ID эксперта          |
| GET    | `/getByAgeCategory/{ageCategory}` | Получить направления по возрастной категории |
| GET    | `/getByAge/{age}`                 | Получить направления по возрасту             |
| POST   | `/`                               | Создать направление                          |
| POST   | `/createAll`                      | Пакетное создание направлений                |
| PATCH  | `/`                               | Обновить направление                         |
| PATCH  | `/updateAgeCategory`              | Обновить возрастную категорию                |
| PATCH  | `/uploadDirectionIcon`            | Загрузить иконку направления                 |
| DELETE | `/{id}`                           | Удалить направление                          |
| DELETE | `/`                               | Удалить все направления                      |
| POST   | `/addAgeCategory`                 | Добавить возрастную категорию к направлению  |
| DELETE | `/removeAgeCategory/{id}`         | Удалить возрастную категорию                 |

### Контроллер платформ

Базовый путь: `/events-service/v1/platforms`

| Метод  | Эндпоинт                | Описание                           |
|--------|-------------------------|------------------------------------|
| GET    | `/`                     | Получить все платформы             |
| GET    | `/{id}`                 | Получить платформу по ID           |
| GET    | `/getByUserId/{userId}` | Получить платформу по ID владельца |
| POST   | `/`                     | Создать платформу                  |
| POST   | `/createAll`            | Пакетное создание платформ         |
| PATCH  | `/`                     | Обновить платформу                 |
| PATCH  | `/updatePlatformOwner`  | Изменить владельца платформы       |
| PATCH  | `/verify/{id}`          | Переключить проверку платформы     |
| DELETE | `/{id}`                 | Удалить платформу                  |
| DELETE | `/`                     | Удалить все платформы              |

### Контроллер Child to Direction (Ребёнок к направлению)

Базовый путь: `/events-service/v1/childToDirection`

| Метод  | Эндпоинт                       | Описание                               |
|--------|--------------------------------|----------------------------------------|
| GET    | `/`                            | Получить все регистрации               |
| GET    | `/{id}`                        | Получить регистрацию по ID             |
| GET    | `/getByChildId/{id}`           | Получить регистрации по ID ребёнка     | 
| GET    | `/getByDirectionId/{id}`       | Получить регистрации по ID направления | 
| POST   | `/`                            | Создать регистрацию                    | 
| PATCH  | `/`                            | Обновить регистрацию                   | 
| PATCH  | `/setTeacherInfo`              | Установить информацию о педагоге       | 
| PATCH  | `/clearTeacherInfo/{recordId}` | Очистить информацию о педагоге         | 
| DELETE | `/{id}`                        | Удалить регистрацию                    | 
| DELETE | `/deleteByChildId/{id}`        | Удалить все регистрации ребёнка        | 
| DELETE | `/`                            | Удалить все регистрации                |

### Контроллер документов направлений

Базовый путь: `/events-service/v1/direction-docs`

| Метод  | Эндпоинт                 | Описание                              |
|--------|--------------------------|---------------------------------------|
| GET    | `/`                      | Получить все документы                |
| GET    | `/{id}`                  | Получить документ по ID               |
| GET    | `/getByUserId/{userId}`  | Получить документы по ID пользователя |
| GET    | `/getByDirectoryId/{id}` | Получить документы по ID направления  |
| POST   | `/`                      | Загрузить документ                    |
| PATCH  | `/`                      | Обновить тип документа                |
| PATCH  | `/fix/{id}`              | Исправить ID эксперта в документе     |
| PATCH  | `/verify/{id}/{status}`  | Проверить документ                    |
| DELETE | `/{id}`                  | Удалить документ                      |
| DELETE | `/`                      | Удалить все документы                 |

### Контроллер возрастных категорий

Базовый путь: `/events-service/v1/ageCategories`

| Метод | Эндпоинт                 | Описание                                        |
|-------|--------------------------|-------------------------------------------------|
| GET   | `/getByDirectionId/{id}` | Получить возрастные категории по ID направления |
| PATCH | `/updatePublicity`       | Обновить публичность категории                  |

### Контроллер отчётов

Базовый путь: `/events-service/v1/rapports`

| Метод | Эндпоинт                         | Описание                             |
|-------|----------------------------------|--------------------------------------|
| GET   | `/getChildRecords/{directionId}` | Скачать отчёт о записях детей (XLSX) |
| GET   | `/getChildrenReport`             | Скачать отчёт обо всех детях (XLSX)  |

### Контроллер статистики (Устарело)

Базовый путь: (Устарел, в скором времени будет удален, есть актуальная замена) `/events-service/v1/statistics`

| Метод | Эндпоинт                         | Описание                                       |
|-------|----------------------------------|------------------------------------------------|
| GET   | `/getPlatformsCount`             | Получить общее количество платформ             |
| GET   | `/getVerifiedPlatformsCount`     | Получить количество проверенных платформ       |
| GET   | `/getDirectionsCount`            | Получить общее количество направлений          |
| GET   | `/getDirectionsWithoutDocsCount` | Получить количество направлений без документов |
| GET   | `/getDirectionsDocsCount`        | Получить количество документов направлений     |
| GET   | `/getLastDocumentUpload`         | Получить время последней загрузки документа    |

> **WebSocket эндпоинт**: `/events-service/topic/statistics`

## Типы документов

Сервис поддерживает различные типы документов:

- **AVATAR** — Аватар пользователя
- **SNILS** — Документ СНИЛС
- **STUDYING_CERTIFICATE** — Справка из учебного заведения
- **ADDITIONAL_STUDYING_CERTIFICATE** — Справка о дополнительном образовании
- **CONSENT_TO_CHILD_PDP** — Согласие на обработку персональных данных ребёнка
- **CONSENT_TO_MENTOR_PDP** — Согласие на обработку персональных данных ментора
- **CONSENT_TO_TUTOR_PDP** — Согласие на обработку персональных данных тьютора
- **CONSENT_TO_EXPERT_PDP** — Согласие на обработку персональных данных эксперта
- **BIRTH_CERTIFICATE** — Свидетельство о рождении
- **DIRECTION_ICON** — Иконка направления
- **TASK** — Задание квалификационного этапа
- **CRITERIA** — Критерии квалификационного этапа
- **STATEMENT** — Ведомость квалификационного этапа
- **FINAL_TASK** — Задание финального этапа
- **FINAL_CRITERIA** — Критерии финального этапа
- **FINAL_STATEMENT** — Ведомость финального этапа
- **DESCRIPTION** — Описание направления
- **TOTAL_PARTICIPANTS_QUALIFYING** — Список участников квалификационного этапа
- **TOTAL_PARTICIPANTS_FINAL** — Список участников финального этапа
- **REGISTRATION_LIST_QUALIFYING** — Список регистрации квалификационного этапа
- **REGISTRATION_LIST_FINAL** — Список регистрации финального этапа

## Функции

### Ограниченный по времени доступ

Сервис реализует контроль доступа, ограниченный по времени, с использованием аннотации `@AccessUntil`, ограничивая
определённые операции (например, регистрацию участников) определёнными временными периодами.

### Проверка событий

События проходят процесс проверки со статусами: UNCHECKED → ACCEPTED/REJECTED.

### Управление очередью участников

Автоматическое управление очередью для регистрации участников на основе лимитов вместимости возрастных категорий.

### Интеграция с Kafka

Сервис публикует события в топики Kafka для:

- Уведомлений о создании направлений
- Уведомлений о создании платформ
- Уведомлений о верификации событий

### gRPC-коммуникация

Межсервисное взаимодействие через gRPC для получения данных пользователей.

### Кэширование

Кэширование на основе Redis для данных пользователей с целью повышения производительности.

### Генерация отчётов

Генерация отчётов в формате Excel для записей участников с использованием Apache POI.

### Поддержка WebSocket

Обновление статистики в реальном времени через WebSocket-подключения.