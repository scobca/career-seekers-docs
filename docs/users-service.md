# Users-service

Микросервис на Spring Boot для управления пользователями, детьми и документами в платформе CareerSeekers. Разработан на
Kotlin и предоставляет REST API, GraphQL и WebSocket эндпоинты.

## Оглавление

- [Обзор](#обзор)
- [Технологический стек](#технологический-стек)
- [Структура проекта](#структура-проекта)
- [Эндпоинты API](#эндпоинты-api)
    - [Аутентификация](#аутентификация)
    - [Управление пользователями](#управление-пользователями)
    - [Управление детьми](#управление-детьми)
    - [Управление документами](#управление-документами)
    - [Статистика](#статистика)
    - [Почтовый сервис](#почтовый-сервис)
- [Роли пользователей](#роли-пользователей)
- [Безопасность](#безопасность)
- [Кэширование](#кэширование)
- [Обмен сообщениями](#обмен-сообщениями)

## Обзор

User-Service — это комплексный микросервис управления пользователями, который обрабатывает:

- Регистрацию, аутентификацию и авторизацию пользователей
- Управление детьми (участниками)
- Управление документами для различных типов пользователей
- Отслеживание статистики через WebSocket
- Постановку задач на отправку писем через Kafka
- Управление привязанными Telegram-ссылками к аккаунтам пользователей

## Технологический стек

- **Основа**: Kotlin + Spring Boot
- **База данных**: PostgreSQL
- **Кэширование**: Redis
- **Обмен сообщениями**: Apache Kafka
- **Безопасность**: JWT с кодированием паролей через BCrypt
- **API**: REST, WebSocket

## Структура проекта

```
src/main/kotlin/org/careerseekers/userservice/
├── UserServiceApplication.kt          # Main application entry point
├── annotations/                        # Custom annotations
├── aspects/                           # AOP aspects for cross-cutting concerns
├── cache/                             # Redis caching components
├── config/                            # Configuration classes
├── controllers/                       # REST and WebSocket controllers
│   ├── graphql/                       # GraphQL controllers
│   └── interfaces/                    # Controller interfaces (CRUD)
├── dto/                               # Data Transfer Objects
├── entities/                          # JPA entities
├── enums/                             # Enumerations
├── exceptions/                        # Custom exceptions
├── io/                                # I/O utilities and converters
├── mappers/                           # Entity-DTO mappers
├── repositories/                      # JPA repositories
├── security/                          # Security configuration and JWT utilities
└── services/                          # Business logic services
```

## Эндпоинты API

### Аутентификация

**Базовый путь**: `/users-service/v1/auth`

| Метод | Эндпоинт          | Описание                                          |
|-------|-------------------|---------------------------------------------------|
| POST  | `/preRegister`    | Начало регистрации (отправляет код подтверждения) |
| POST  | `/register`       | Завершить регистрацию пользователя                |
| POST  | `/login`          | Вход пользователя (возвращает JWT-токены)         |
| POST  | `/updateTokens`   | Обновить JWT-токены                               |
| POST  | `/forgotPassword` | Запросить сброс пароля                            |
| POST  | `/verifyCode`     | Подтвердить код по email                          |
| POST  | `/resetPassword`  | Сбросить пароль с кодом подтверждения             |

### Управление пользователями

**Базовый путь**: `/users-service/v1/users`

| Метод  | Эндпоинт                            | Описание                                                                    |
|--------|-------------------------------------|-----------------------------------------------------------------------------|
| GET    | `/`                                 | Получить всех пользователей                                                 |
| GET    | `/{id}`                             | Получить пользователя по ID                                                 |
| GET    | `/getByEmail/{email}`               | Получить пользователя по email                                              |
| GET    | `/getByMobileNumber/{mobileNumber}` | Получить пользователей по номеру телефона                                   |
| GET    | `/getByRole/{role}`                 | Получить пользователей по роли                                              |
| GET    | `/getByTutorId/{id}`                | Получить пользователей по ID куратора (если пользователь имеет роль EXPERT) |
| POST   | `/`                                 | Создать нового пользователя                                                 |
| POST   | `/createAll`                        | Создать нескольких пользователей                                            |
| PATCH  | `/`                                 | Обновить пользователя                                                       |
| PATCH  | `/updateUserRole`                   | Обновить роль пользователя (только Admin)                                   |
| PATCH  | `/verify`                           | Подтвердить пользователя (только Admin)                                     |
| DELETE | `/{id}`                             | Удалить пользователя по ID                                                  |
| DELETE | `/`                                 | Удалить всех пользователей (только Admin)                                   |

### Управление детьми

**Базовый путь**: `/users-service/v1/children`

| Метод  | Эндпоинт                | Описание                          |
|--------|-------------------------|-----------------------------------|
| GET    | `/`                     | Получить всех детей               |
| GET    | `/{id}`                 | Получить ребенка по ID            |
| GET    | `/getByUserId/{userId}` | Получить детей по ID пользователя |
| POST   | `/`                     | Создать ребенка                   |
| POST   | `/createAll`            | Создать нескольких детей          |
| PATCH  | `/`                     | Обновить ребенка                  |
| DELETE | `/{id}`                 | Удалить ребенка по ID             |
| DELETE | `/`                     | Удалить всех детей (только Admin) |

**Эндпоинт V2**: `/users-service/v2/children`

| Метод | Эндпоинт           | Описание                                      |
|-------|--------------------|-----------------------------------------------|
| POST  | `/createChildPack` | Создать ребенка с документами в одном запросе |

### Управление документами

#### Документы детей

**Базовый путь**: `/users-service/v1/child-docs`

| Метод  | Эндпоинт                          | Описание                                     |
|--------|-----------------------------------|----------------------------------------------|
| GET    | `/`                               | Получить все детские документы               |
| GET    | `/{id}`                           | Получить детские документы по ID             |
| GET    | `/getByChildId/{id}`              | Получить документы по ID ребенка             |
| GET    | `/getBySnilsNumber/{snilsNumber}` | Получить документы по номеру СНИЛС           |
| POST   | `/`                               | Создать детские документы (multipart)        |
| PATCH  | `/`                               | Обновить детские документы (multipart)       |
| DELETE | `/{id}`                           | Удалить документы по ID                      |
| DELETE | `/`                               | Удалить все детские документы (только Admin) |

#### Документы экспертов

**Базовый путь**: `/users-service/v1/expert-docs`

| Метод  | Эндпоинт            | Описание                                       |
|--------|---------------------|------------------------------------------------|
| GET    | `/`                 | Получить все документы экспертов               |
| GET    | `/{id}`             | Получить документы эксперта по ID              |
| GET    | `/getByUserId/{id}` | Получить документы по ID пользователя          |
| POST   | `/`                 | Создать документы эксперта                     |
| PATCH  | `/`                 | Обновить документы эксперта                    |
| DELETE | `/{id}`             | Удалить документы эксперта по ID               |
| DELETE | `/`                 | Удалить все документы экспертов (только Admin) |

#### Документы менторов

**Базовый путь**: `/users-service/v1/mentor-docs`

| Метод  | Эндпоинт            | Описание                                      |
|--------|---------------------|-----------------------------------------------|
| GET    | `/`                 | Получить все документы менторов               |
| GET    | `/{id}`             | Получить документы ментора по ID              |
| GET    | `/getByUserId/{id}` | Получить документы по ID пользователя         |
| POST   | `/`                 | Создать документы ментора (multipart)         |
| PATCH  | `/`                 | Обновить документы ментора (multipart)        |
| DELETE | `/{id}`             | Удалить документы ментора по ID               |
| DELETE | `/`                 | Удалить все документы менторов (только Admin) |

#### Документы тьюторов (кураторов площадок)

**Базовый путь**: `/users-service/v1/tutor-docs`

| Метод  | Эндпоинт            | Описание                                      |
|--------|---------------------|-----------------------------------------------|
| GET    | `/`                 | Получить все документы тьюторов               |
| GET    | `/{id}`             | Получить документы тьютора по ID              |
| GET    | `/getByUserId/{id}` | Получить документы по ID пользователя         |
| POST   | `/`                 | Создать документы тьютора                     |
| PATCH  | `/`                 | Обновить документы тьютора                    |
| DELETE | `/{id}`             | Удалить документы тьютора по ID               |
| DELETE | `/`                 | Удалить все документы тьюторов (только Admin) |

### Telegram-ссылки

**Базовый путь**: `/users-service/v1/telegram-links`

| Метод  | Эндпоинт     | Описание                                   |
|--------|--------------|--------------------------------------------|
| GET    | `/`          | Получить все Telegram-ссылки               |
| GET    | `/{id}`      | Получить Telegram-ссылку по ID             |
| POST   | `/`          | Создать Telegram-ссылку                    |
| POST   | `/createAll` | Создать несколько Telegram-ссылок          |
| PATCH  | `/`          | Обновить Telegram-ссылку                   |
| DELETE | `/{id}`      | Удалить Telegram-ссылку по ID              |
| DELETE | `/`          | Удалить все Telegram-ссылки (только Admin) |

### Ссылки менторов (пригласительные ссылки, по которым ментор может "привязать" к себе ребенка)

**Базовый путь**: `/users-service/v1/mentor-links`

| Метод  | Эндпоинт                  | Описание                                   |
|--------|---------------------------|--------------------------------------------|
| GET    | `/`                       | Получить все ссылки менторов               |
| GET    | `/{id}`                   | Получить ссылку ментора по ID              |
| GET    | `/getByUserId/{id}`       | Получить ссылку ментора по ID пользователя |
| GET    | `/getByBiscuit/{biscuit}` | Получить ссылку ментора по токену biscuit  |
| POST   | `/`                       | Создать ссылку ментора                     |
| DELETE | `/{id}`                   | Удалить ссылку ментора по ID               |
| DELETE | `/`                       | Удалить все ссылки менторов (только Admin) |

### Статистика

**REST базовый путь** (Устарел, в скором времени будет удален, есть актуальная замена): `/users-service/v1/statistics`

| Метод | Эндпоинт            | Описание                          |
|-------|---------------------|-----------------------------------|
| GET   | `/getTutorsInfo`    | Получить статистику тьюторов      |
| GET   | `/getExpertsInfo`   | Получить статистику экспертов     |
| GET   | `/getMentorsInfo`   | Получить статистику менторов      |
| GET   | `/getUsersInfo`     | Получить статистику пользователей |
| GET   | `/getChildrenCount` | Получить количество детей         |

**WebSocket эндпоинт**: `/users-service/topic/statistics`

- Маппинг сообщений: `/getStatistics`
- Возвращает агрегированную статистику для всех типов пользователей

### Почтовый сервис

**Базовый путь**: (Устарело, в скором времени будет удален безвозвратно) `/users-service/v1/mailer`

| Метод | Эндпоинт | Описание                       |
|-------|----------|--------------------------------|
| POST  | `/send`  | Отправить email (только Admin) |

### GraphQL

**Эндпоинт**: Стандартный GraphQL эндпоинт

| Запрос                         | Описание                              |
|--------------------------------|---------------------------------------|
| `user(id: Long)`               | Получить пользователя по ID           |
| `users`                        | Получить всех пользователей           |
| `usersByChildIds(ids: [Long])` | Получить пользователей по ID их детей |

## Роли пользователей

| Роль     | Описание                        |
|----------|---------------------------------|
| `USER`   | Обычный пользователь (родитель) |
| `MENTOR` | Ментор для детей                |
| `TUTOR`  | Тьютор (куратор площадки)       |
| `EXPERT` | Эксперт                         |
| `ADMIN`  | Администратор с полным доступом |

## Безопасность

- **Аутентификация**: JWT-аутентификация с access и refresh токенами
- **Кодирование паролей**: BCrypt
- **Авторизация**: Контроль доступа на основе ролей с использованием Spring Security `@PreAuthorize`
- **Управление токенами**: Refresh токены хранятся в базе данных с отслеживанием UUID
- **Контроль доступа**: Кастомная аннотация `@AccessUntil` для ограниченного по времени доступа к эндпоинтам

## Кэширование

- **Основа**: Redis
- **Конфигурация**: Время жизни записей кэша — 30 минут
- **Сценарии использования**:
    - Кэширование данных пользователей
    - Коды подтверждения
    - Временные пароли

## Обмен сообщениями

- **Основа**: Apache Kafka
- **Топики**:
    - `EMAIL_SENDING_TASKS` — Задачи на отправку электронных писем (общая форма)
    - `TG_LINKS_NOTIFICATION` — Уведомления о привязке Telegram-ссылки к аккаунту
